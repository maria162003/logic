rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // üë• USUARIOS - Solo pueden leer/escribir sus propios datos
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // üìã CONSULTAS - Clientes y abogados asignados pueden acceder
    match /consultations/{consultationId} {
      // Leer: cliente o abogado asignado
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.clientId || 
         request.auth.uid == resource.data.lawyerId);
      
      // Crear: solo clientes pueden crear consultas
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.clientId;
      
      // Actualizar: cliente o abogado asignado
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.clientId || 
         request.auth.uid == resource.data.lawyerId);
      
      // Eliminar: solo el cliente puede eliminar
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.clientId;
    }
    
    // ‚öñÔ∏è ABOGADOS - Perfiles p√∫blicos para lectura, solo el propietario puede escribir
    match /lawyers/{lawyerId} {
      allow read: if true;  // Lectura p√∫blica
      allow write: if request.auth != null && request.auth.uid == lawyerId;
    }
    
    // üí¨ CHATS - Solo participantes pueden acceder
    match /chats/{chatId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && 
        request.auth.uid in request.resource.data.participants;
    }
    
    // üì® MENSAJES - Solo participantes del chat pueden acceder
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/chats/$(chatId)) &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
    
    // üìÑ DOCUMENTOS - Solo propietario y abogado asignado
    match /documents/{documentId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.uploadedBy || 
         request.auth.uid == resource.data.lawyerId);
    }
    
    // üè™ CASOS P√öBLICOS - Marketplace
    match /public_cases/{caseId} {
      allow read: if request.auth != null;  // Abogados pueden leer todos los casos
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.clientId;  // Solo clientes pueden crear
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.clientId;  // Solo el cliente puede actualizar
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.clientId;  // Solo el cliente puede eliminar
    }
    
    // üìù POSTULACIONES A CASOS - Applications
    match /case_applications/{applicationId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.lawyerId || 
         request.auth.uid == resource.data.clientId);  // Solo abogado postulante o cliente propietario
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.lawyerId;  // Solo abogados pueden postularse
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.lawyerId || 
         request.auth.uid == resource.data.clientId);  // Ambos pueden actualizar estado
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.lawyerId;  // Solo el abogado puede eliminar su postulaci√≥n
    }
    
    // üìä ESTAD√çSTICAS - Solo lectura para usuarios autenticados
    match /stats/{statId} {
      allow read: if request.auth != null;
      allow write: if false; // Solo el sistema puede escribir estad√≠sticas
    }
    
    // üîî NOTIFICACIONES - Solo el usuario destinatario
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // ‚≠ê VALORACIONES - Solo el cliente puede valorar
    match /reviews/{reviewId} {
      allow read: if true; // Lectura p√∫blica
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.clientId;
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.clientId;
    }
    
    // üè™ CASOS P√öBLICOS - Marketplace de casos
    match /public_cases/{caseId} {
      // Lectura: todos los abogados autenticados
      allow read: if request.auth != null;
      // Crear: solo clientes pueden publicar casos
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.clientId;
      // Actualizar/Eliminar: solo el cliente propietario
      allow update, delete: if request.auth != null && 
        request.auth.uid == resource.data.clientId;
    }
    
    // üìã POSTULACIONES A CASOS - Propuestas de abogados
    match /case_applications/{applicationId} {
      // Leer: abogado que se postul√≥ o cliente due√±o del caso
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.lawyerId || 
         request.auth.uid == resource.data.clientId);
      // Crear: solo abogados pueden postularse
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.lawyerId;
      // Actualizar: abogado que se postul√≥ o cliente (para cambiar estado)
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.lawyerId || 
         request.auth.uid == resource.data.clientId);
      // Eliminar: solo el abogado que se postul√≥
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.lawyerId;
    }
  }
}
